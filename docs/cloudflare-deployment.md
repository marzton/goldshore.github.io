# Cloudflare Deployment Playbook

Goldshore ships three surface areas on Cloudflare:

1. **Marketing site** (`apps/web`) deployed via Cloudflare Pages.
2. **Admin console** (`apps/admin`) deployed to a separate Pages project
   and protected by Cloudflare Access.
3. **API worker** (`apps/api-worker`) serving JSON endpoints on
   `api.goldshore.org` (plus preview/dev variants).

This guide explains how the pieces fit together and the controls to
review before production releases.

## 1. Pages projects

Two Pages projects exist: `goldshore-web` for the public marketing site
and `goldshore-admin` for the admin console. Both projects build from
this repository. Their deployment settings live under
`infra/policies/cloudflare/pages.*.json` and mirror the values defined in
`infra/cf/config.json`.

Key expectations:

- Production deployments run on the `main` branch.
- Preview deployments map to the `preview` (marketing) and
  `admin-preview` branches.
- Development sandbox builds (`dev`/`admin-dev`) stay on the autogenerated
  `*.pages.dev` hostnames.
- Environment variables expose the API base URL so the clients talk to
  the Worker domains described below.

## 2. API worker

The API lives in `apps/api-worker/src/index.ts` and is deployed with
`wrangler deploy --config wrangler.worker.toml`. The worker routes the
following hostnames:

- `api.goldshore.org/*`
- `api-preview.goldshore.org/*`
- `api-dev.goldshore.org/*`

Dependencies:

- KV namespaces: `KV_SESSIONS`, `KV_CACHE`
- Durable Object: `SessionDO`
- Queue: `goldshore-events` (with `goldshore-dlq` as the dead-letter
  queue)
- Environment variables: `GOLDSHORE_ENV`, `GOLDSHORE_ORIGIN`,
  `GOLDSHORE_CORS`, `JWT_AUDIENCE`, `JWT_ISSUER`, `RATE_LIMIT_MAX`,
  `RATE_LIMIT_WINDOW`
- Secrets set via `wrangler secret put`: `GOLDSHORE_JWT_SECRET`,
  `GITHUB_APP_PRIVATE_KEY`, `GITHUB_WEBHOOK_SECRET`, and any other runtime
  credentials.

A cron trigger (`*/30 * * * *`) emits heartbeats onto the queue for
observability.

## 3. DNS requirements

`infra/policies/cloudflare/dns.requirements.json` enumerates the expected
DNS records for `goldshore.org`. Highlights:

- The apex (`@`) and `www` records point at `goldshore-web.pages.dev`
  (CNAME flattening keeps them proxied while routing to Pages).
- Preview domains (`preview`, `dev`) and admin hostnames
  (`admin`, `admin-preview`, `admin-dev`) map directly to their
  respective Pages-generated domains.
- API hostnames (`api`, `api-preview`, `api-dev`) CNAME to the Workers
  subdomain `goldshore-api.goldshore.workers.dev`.
- Email TXT records enforce SPF and DMARC policies.

Use the helper script `infra/scripts/enforce-dns.sh` or the Cloudflare UI
to keep DNS in sync with the documented inventory.

## 4. Deployment flow

1. Merge changes to `main`. Turborepo pipelines build the web/admin
   bundles (`npm run build:web` / `npm run build:admin`).
2. Deploy the Pages projects via CI (or manually with
   `npx wrangler pages deploy`). Preview environments deploy from their
   respective branches.
3. Deploy the API worker using `wrangler deploy --config wrangler.worker.toml`.
4. Verify the API by curling `https://api.goldshore.org/health` and
   executing authenticated smoke tests.
5. Confirm DNS records remain proxied and pointed at the expected
   origins.

## 5. Troubleshooting tips

- **Unexpected 4xx from the API** – Check bearer tokens. Most endpoints
  require JWT auth; `GET /health` is the only public route.
- **CORS failures** – Update `GOLDSHORE_CORS` in the worker deployment so
  the new origin is allowed.
- **Pages preview mismatch** – Ensure the `preview`/`dev` hostnames in
  DNS still target the Pages subdomains listed in the DNS policy.
- **Worker not receiving traffic** – Confirm the `api*` hostnames resolve
  to `goldshore-api.goldshore.workers.dev` and that the route is assigned
  to the `goldshore-api` script.
