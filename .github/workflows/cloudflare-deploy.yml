name: Deploy to Cloudflare

on:
  push:
    branches:
      - main
      - preview/**
      - dev/**
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy"
        required: true
        type: choice
        options:
          - production
          - preview
          - dev
      ref:
        description: "Git ref (branch or tag) to deploy"
        required: false
        default: ""

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
      ZONE_ID: ${{ secrets.CF_ZONE_ID }}
      PAGES_PROJECT: goldshore-org
      DNS_TARGET_PRODUCTION: ${{ secrets.CF_DNS_TARGET_PRODUCTION }}
      DNS_TARGET_PREVIEW: ${{ secrets.CF_DNS_TARGET_PREVIEW }}
      DNS_TARGET_DEV: ${{ secrets.CF_DNS_TARGET_DEV }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.ref || github.ref }}

      - name: Determine deployment configuration
        id: plan
        run: |
          set -euo pipefail

          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            ENVIRONMENT="${{ github.event.inputs.environment }}"
            if [[ -z "${ENVIRONMENT}" ]]; then
              echo "Workflow dispatch requires an environment." >&2
              exit 1
            fi
            BRANCH_INPUT="${{ github.event.inputs.ref }}"
            if [[ -n "${BRANCH_INPUT}" ]]; then
              BRANCH="${BRANCH_INPUT}"
            else
              BRANCH="${ENVIRONMENT}"
            fi
          else
            REF="${GITHUB_REF}"
            case "${REF}" in
              refs/heads/main)
                ENVIRONMENT="production"
                BRANCH="main"
                ;;
              refs/heads/preview/*)
                ENVIRONMENT="preview"
                BRANCH="${REF#refs/heads/}"
                ;;
              refs/heads/dev/*)
                ENVIRONMENT="dev"
                BRANCH="${REF#refs/heads/}"
                ;;
              *)
                echo "Unsupported ref ${REF}" >&2
                exit 1
                ;;
            esac
          fi

          case "${ENVIRONMENT}" in
            production)
              DNS_NAME="api.goldshore.org"
              DNS_TARGET="${DNS_TARGET_PRODUCTION:-}"
              ;;
            preview)
              DNS_NAME="api-preview.goldshore.org"
              DNS_TARGET="${DNS_TARGET_PREVIEW:-}"
              ;;
            dev)
              DNS_NAME="api-dev.goldshore.org"
              DNS_TARGET="${DNS_TARGET_DEV:-}"
              ;;
            *)
              echo "Unknown environment ${ENVIRONMENT}" >&2
              exit 1
              ;;
          esac

          echo "environment=${ENVIRONMENT}" >> "${GITHUB_OUTPUT}"
          echo "branch=${BRANCH}" >> "${GITHUB_OUTPUT}"
          echo "dns_name=${DNS_NAME}" >> "${GITHUB_OUTPUT}"
          if [[ -n "${DNS_TARGET}" ]]; then
            echo "dns_target=${DNS_TARGET}" >> "${GITHUB_OUTPUT}"
          fi

      - name: Install Node dependencies
        run: npm ci

      - name: Deploy Worker router
        run: npx wrangler deploy --env ${{ steps.plan.outputs.environment }}

      - name: Deploy Pages artifact
        run: npx wrangler pages deploy ./ --project-name=${PAGES_PROJECT} --branch ${{ steps.plan.outputs.branch }}

      - name: Upsert Cloudflare DNS record
        if: ${{ steps.plan.outputs.dns_target != '' }}
        env:
          DNS_NAME: ${{ steps.plan.outputs.dns_name }}
          DNS_TARGET: ${{ steps.plan.outputs.dns_target }}
        run: |
          set -euo pipefail
          API_BASE="https://api.cloudflare.com/client/v4/zones/${ZONE_ID}/dns_records"

          if [[ "${DNS_TARGET}" =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}$ ]]; then
            DNS_TYPE="A"
          else
            DNS_TYPE="CNAME"
          fi

          DATA=$(jq -n \
            --arg type "${DNS_TYPE}" \
            --arg name "${DNS_NAME}" \
            --arg content "${DNS_TARGET}" \
            '{type: $type, name: $name, content: $content, ttl: 120, proxied: true}')

          LOOKUP=$(curl -sS -X GET "${API_BASE}" \
            -G \
            --data-urlencode "name=${DNS_NAME}" \
            --data-urlencode "type=${DNS_TYPE}" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            -H "Content-Type: application/json")

          RECORD_ID=$(echo "${LOOKUP}" | jq -r '.result[0].id // empty')

          if [[ -n "${RECORD_ID}" ]]; then
            curl -sS -X PUT "${API_BASE}/${RECORD_ID}" \
              -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
              -H "Content-Type: application/json" \
              --data "${DATA}" \
              | jq -e '.success == true' > /dev/null
          else
            curl -sS -X POST "${API_BASE}" \
              -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
              -H "Content-Type: application/json" \
              --data "${DATA}" \
              | jq -e '.success == true' > /dev/null
          fi

          echo "DNS record ${DNS_NAME} updated"

      - name: Skip DNS update when target is undefined
        if: ${{ steps.plan.outputs.dns_target == '' }}
        run: echo "No DNS target configured for ${{ steps.plan.outputs.environment }}; skipping DNS update."
