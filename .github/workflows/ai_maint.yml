name: AI maintenance (safe)

on:
  schedule: [{ cron: "0 5 * * *" }]
  workflow_dispatch:

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENAI_PROJECT_ID: ${{ secrets.OPENAI_PROJECT_ID }}
    steps:
      - uses: actions/checkout@v4

      - name: Ensure repository is conflict-free
        run: |
          conflicts=$(git ls-files -u)
          if [ -n "$conflicts" ]; then
            echo "::error::Unresolved merge conflicts detected" >&2
            echo "$conflicts" >&2
            exit 1
          fi

          markers=$(git grep -n '<<<<<<<' || true)
          if [ -n "$markers" ]; then
            echo "::error::Merge conflict markers present in working tree" >&2
            echo "$markers" >&2
            exit 1
          fi

          echo "No merge conflicts detected."

      - name: Install node
        uses: actions/setup-node@v4
        with: { node-version: 20 }

      - name: Install tooling
        run: |
          npm i -D stylelint stylelint-config-standard htmlhint eslint lighthouse @actions/core @actions/github

      - name: Install dependencies
        run: npm install --no-package-lock

      - name: Lint CSS/HTML/JS
        run: |
          npx stylelint "apps/web/src/**/*.css"
          npx htmlhint "apps/web/src/**/*.astro" || true
          npx eslint "apps/web/src/**/*.{js,ts,astro}" || true

      - name: CSS Guardrails (block binaries/huge files)
        run: |
          bad=$(find apps/web -name "*.css" -size +500k -print -o -type f -name "*.css" -exec file -bi {} \; | { grep -v "text/" || test $? -eq 1; })
          if [ -n "$bad" ]; then echo "âŒ Bad CSS detected"; echo "$bad"; exit 1; fi

      - name: Build site (Astro)
        working-directory: apps/web
        run: |
          npm install --no-package-lock
          npx astro build

      - name: Archive site assets
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ai-maint-web-dist
          path: apps/web/dist
          retention-days: 7

      - name: Lighthouse smoke (static)
        env:
          LH_THRESHOLD: "0.85"
        run: |
          npx http-server apps/web/dist -p 4173 &
          SERVER_PID=$!
          sleep 2
          npx lighthouse http://localhost:4173 \
            --only-categories=performance,accessibility,best-practices,seo \
            --output=json \
            --output-path=./lh.json \
            --quiet
          kill $SERVER_PID
          score=$(jq '[.categories.performance.score,.categories.accessibility.score,.categories.seo.score] | add/3' lh.json)
          echo "Average score: $score"
          node -e "const score=parseFloat(process.argv[1]);const threshold=parseFloat(process.env.LH_THRESHOLD);if(!(score>=threshold)){console.error('Lighthouse average below threshold');process.exit(1);}" "$score"

      - name: Persist audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ai-maint-lighthouse-report
          path: lh.json
          if-no-files-found: warn
          retention-days: 7

      - name: AI copy/link suggestions (PR only)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          node - <<'JS'
          const fs = require('fs');
          const { execSync } = require('child_process');

          const files = ['apps/web/src/pages/index.astro'];
          let changed = false;

          for (const file of files) {
            const original = fs.readFileSync(file, 'utf-8');
            const updated = original.replace(/we steer markets, not money/gi, 'We build market tools that respect capital and context.');
            if (updated !== original) {
              fs.writeFileSync(file, updated);
              changed = true;
            }
          }

          if (!changed) {
            console.log('No edits suggested.');
            process.exit(0);
          }

          execSync('git config user.email "bot@goldshore.org"');
          execSync('git config user.name "goldshore-ai"');
          try {
            execSync('git checkout -b chore/ai-maint');
          } catch (error) {
            execSync('git checkout chore/ai-maint');
          }
          execSync('git add -A');
          execSync('git commit -m "AI: copy polish + link graph refresh"');
          execSync('git push --set-upstream origin chore/ai-maint');
          JS
