name: Deploy goldshore-api

on:
  push:
    branches:
      - main
    paths:
      - infra/cf/**
      - src/**
      - wrangler.*
      - package.json
      - .github/workflows/cf-deploy.yml
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install
        run: npm ci

      - name: Wrangler
        run: npm i -g wrangler

      - name: Repair config drift (vars & triggers)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CODEX_JWT_HS256_KEY: ${{ secrets.CODEX_JWT_HS256_KEY }}
          GOLDSHORE_CORS_VALUE: https://goldshore.org,https://www.goldshore.org,https://admin.goldshore.org,https://preview.goldshore.org,http://localhost:5173,http://127.0.0.1:5173
        run: |
          wrangler secret put CODEX_JWT_HS256_KEY --value "$CODEX_JWT_HS256_KEY" --silent || true
          wrangler secret put GOLDSHORE_CORS --value "$GOLDSHORE_CORS_VALUE" --silent || true
          wrangler deploy --minify
