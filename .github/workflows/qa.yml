name: QA (Lighthouse + a11y)
on: [pull_request, workflow_dispatch]
jobs:
  qa:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: npm i -D http-server lighthouse
      - name: Build
        run: npm run build
      - name: Lighthouse
        run: |
          http-server apps/web/dist -p 4173 & sleep 2
          npx lighthouse http://localhost:4173 --only-categories=performance,accessibility,seo --output=json --output-path=./lh.json --quiet
          node -e "const s=require('./lh.json');const ok=[s.categories.performance,s.categories.accessibility,s.categories.seo].every(x=>x.score>=0.9);if(!ok){console.error('Lighthouse gate failed');process.exit(1)}"
