{
  "codex_guardrails_version": "2025-10-31",
  "fail_fast": true,
  "retries": { "max_attempts": 3, "base_ms": 750, "jitter": true },
  "concurrency": { "max_inflight": 1, "queue_len": 20 },
  "preflights": [
    {
      "id": "secrets_present",
      "type": "env.present_all",
      "vars": [
        "CLOUDFLARE_API_TOKEN",
        "CLOUDFLARE_ACCOUNT_ID",
        "CODEX_JWT_HS256_KEY",
        "GITHUB_CLIENT_SECRET",
        "GITHUB_PRIVATE_KEY",
        "GITHUB_WEBHOOK_SECRET"
      ],
      "remediation": "Add missing secrets to repo → Settings → Secrets and variables → Actions."
    },
    {
      "id": "wrangler_version_ok",
      "type": "cli.version_gte",
      "tool": "wrangler",
      "min": "3.78.0",
      "remediation": "npm i -g wrangler@latest"
    },
    {
      "id": "cf_route_ok",
      "type": "http.expect_code",
      "url": "https://api.goldshore.org/health",
      "method": "GET",
      "expect": 200,
      "timeout_ms": 5000,
      "remediation": "Ensure Worker routes include api.goldshore.org/* and deploy."
    },
    {
      "id": "access_bypass_webhook",
      "type": "http.disallow_access_portal",
      "url": "https://api.goldshore.org/github/webhook",
      "method": "GET",
      "expect": [403, 405],
      "remediation": "Add Zero Trust policy: Bypass path /github/webhook on api.goldshore.org."
    },
    {
      "id": "github_app_urls_ok",
      "type": "regex.assert",
      "value": {
        "homepage_url": "https://api.goldshore.org/github",
        "callback_url": "https://api.goldshore.org/auth/github/callback",
        "setup_url": "https://admin.goldshore.org/install",
        "webhook_url": "https://api.goldshore.org/github/webhook"
      },
      "pattern": "^https://(api|admin)\\.goldshore\\.org/.*$",
      "remediation": "Update GitHub App settings to use api/admin.goldshore.org; no *.workers.dev."
    },
    {
      "id": "queues_exist",
      "type": "cli.contains_lines",
      "cmd": "wrangler queues list",
      "must_include": ["goldshore-events", "goldshore-dlq"],
      "remediation": "wrangler queues create goldshore-events && wrangler queues create goldshore-dlq --dlq"
    },
    {
      "id": "api_worker_only",
      "type": "file.json.assert",
      "path": "infra/cf/config.json",
      "assert": "workers.length == 1 && workers[0].name == 'goldshore-api'",
      "remediation": "Remove legacy router/admin Workers; only goldshore-api should remain."
    },
    {
      "id": "do_migrations_safe",
      "type": "file.json.assert",
      "path": "infra/cf/config.json",
      "assert": "workers[0].migrations is monotonic, unique tags; includes ['SessionDO','RateLimiterDO']",
      "remediation": "Bump tag to next (v3+) if conflict; never reuse tags."
    },
    {
      "id": "poll_requires_jwt",
      "type": "http.expect_code",
      "url": "https://api.goldshore.org/poll",
      "method": "GET",
      "expect": 401,
      "timeout_ms": 5000,
      "remediation": "Ensure CODEX_JWT_REQUIRED=true and the goldshore-api Worker enforces Bearer JWT."
    },
    {
      "id": "cors_single_origin",
      "type": "http.expect_header",
      "url": "https://api.goldshore.org/health",
      "method": "GET",
      "headers": { "Origin": "https://admin.goldshore.org" },
      "header": "Access-Control-Allow-Origin",
      "expect_value": "https://admin.goldshore.org",
      "remediation": "Echo a single origin from GOLDSHORE_CORS; handle OPTIONS preflight."
    }
  ],
  "idempotency": {
    "keys": ["action_id", "target", "sha"],
    "store": "ephemeral", 
    "ttl_seconds": 86400
  },
  "circuit_breakers": [
    {
      "id": "429_storm",
      "if_rate": { "status": 429, "over": 0.15, "window_sec": 120 },
      "action": "halt",
      "cooldown_sec": 300,
      "remediation": "Back off; verify limiter budgets; reduce polling frequency."
    }
  ],
  "telemetry": {
    "log_level": "info",
    "emit_to": "queue:goldshore-events",
    "fields": ["action_id","status","duration_ms","attempt","error_code","preflight_id"]
  }
}
